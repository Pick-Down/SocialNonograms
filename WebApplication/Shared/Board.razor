@using SN.Model
@using SN.Model.Board.Cells
@using SN.Model.Board.Listener
@using SN.Model.Solver
@inject IBoardListener _listener

<div>
    <table style="margin-left: auto; margin-right: auto; user-select: none" onmousemove="">
        @for (int row = 0; row < BoardModel.FullBoard.GetLength(0); row++)
        {
            var rowNum = row;
            <tr>
                @for (int col = 0; col < BoardModel.FullBoard.GetLength(1); col++)
                {
                    var colNum = col;
                    <td class="@BoardModel.FullBoard[row,col].GetCellStyles()">
                        <div class="content big"  
                             @onmousedown="@(e => HandleMouseDown(e, rowNum, colNum))" 
                             @onmouseover="@(_ => HandleMouseEnter(rowNum, colNum))"
                             @onmouseup="@(e => HandleMouseUp(e, rowNum, colNum))"
                             @oncontextmenu="@(e => HandleRightClick(e, rowNum, colNum))" 
                             @oncontextmenu:preventDefault="true">
                             @BoardModel.FullBoard[row, col].Content
                        </div>
                    </td>
                }
            </tr>
        }
    </table>
</div>
<br/>
<br/>
<br/>   

@code {
    [Parameter]
    public BoardModel BoardModel { get; set; }
    [Parameter]
    public IBoardSolver BoardSolver { get; set; }
    [Parameter]
    public EventCallback OnComplete { get; set; }

    private bool _isComplete;

    protected override void OnInitialized()
    {
        BoardModel.Register(_listener);
    }

    private void HandleMouseDown(MouseEventArgs args, int row, int col)
    {
        if (args.Button != 0)
            return;
        if (!_isComplete)
        {
            BoardModel.FullBoard[row, col].OnLeftMouseClick(row, col);
            _isComplete = CheckComplete();
            if (_isComplete)
                OnComplete.InvokeAsync();
        }
    }
    
    private void HandleMouseEnter(int row, int col)
    {
        if (!_isComplete)
        {
            _listener.OnMouseMove(new RowColPair(row, col));
        }
    }
    
    private void HandleMouseUp(MouseEventArgs mouseEventArgs, int row, int col)
    {
        if (mouseEventArgs.Button != 0)
            return;
        if (!_isComplete)
        {
            _listener.OnMouseUp(new RowColPair(row, col));
        }
    }

    private void HandleRightClick(MouseEventArgs args, int row, int col)
    {
        if (!_isComplete)
        {
            BoardModel.FullBoard[row, col].OnRightMouseClick(row, col);
            _isComplete = CheckComplete();
            if (_isComplete)
                OnComplete.InvokeAsync();
        }
    }

    private bool CheckComplete()
    {
        return BoardSolver.IsComplete();
    }
}